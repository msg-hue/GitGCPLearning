name: Deploy to GCP

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to VM
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.GCP_HOST }}
        username: ${{ secrets.GCP_USERNAME }}
        key: ${{ secrets.GCP_SSH_KEY }}
        script: |
          cd ~/GitGCPLearning
          git pull origin main
          
          # Backend
          cd ~/GitGCPLearning/backend/PMS_APIs
          dotnet build
          pkill -f "dotnet run"
          nohup dotnet run --urls "http://0.0.0.0:5009" > ~/backend.log 2>&1 &
          
          # Frontend
          cd ~/GitGCPLearning/frontend
          npm install
          npm run build
          pkill -f "serve"
          nohup serve -s build -l 5010 > ~/frontend.log 2>&1 &